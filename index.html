<!DOCTYPE html>
<html lang="es">

<head>
<meta charset="UTF-8">
<title>Login Inteligente Seguro</title>

<style>
body{
background:black;
font-family:Arial;
margin:0;
height:100vh;
display:flex;
justify-content:center;
align-items:center;
color:white;
}
#switch{
display:none;
}
.container{
perspective:1200px;
position:relative;
}
.card{
width:380px;
height:420px;
position:relative;
transform-style:preserve-3d;
transition:1s;
}
#switch:checked ~ .container .card{
transform:rotateY(180deg);
}
.side{
position:absolute;
width:100%;
height:100%;
border-radius:20px;
background:black;
padding:25px;
backface-visibility:hidden;
box-shadow:
0 0 10px #00ff00,
0 0 20px #00ff00,
0 0 40px #00ff00;
animation:borde 3s linear infinite;
}
@keyframes borde{
0%{box-shadow:0 0 10px #00ff00;}
50%{box-shadow:0 0 50px #00ff00;}
100%{box-shadow:0 0 10px #00ff00;}
}
.register{
transform:rotateY(180deg);
}
h2{
text-align:center;
}
input{
width:95%;
padding:12px;
margin-top:10px;
border-radius:8px;
border:2px solid #00ff00;
background:black;
color:white;
}
button{
margin-top:20px;
width:100%;
padding:13px;
border:none;
border-radius:10px;
background:linear-gradient(to right,#006400,#00ff00);
color:white;
font-size:16px;
cursor:pointer;
}
.sideButton{
position:absolute;
top:50%;
transform:translateY(-50%);
width:80px;
height:250px;
cursor:pointer;
}
.arrow{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
font-size:40px;
opacity:0;
transition:0.3s;
}
.container:hover .arrow{
opacity:1;
}
.left{ left:-110px; }
.right{ right:-110px; }
#switch:not(:checked) ~ .container .left{
display:none;
}
#switch:checked ~ .container .right{
display:none;
}
.notify{
position:absolute;
top:30%;
width:220px;
padding:15px;
border-radius:10px;
background:#111;
border:2px solid #00ff00;
box-shadow:0 0 10px #00ff00;
font-size:14px;
display:none;
}
.notifyLogin{
left:20px;
}
.notifyRegister{
right:20px;
}
</style>

</head>

<body>

<input type="checkbox" id="switch">

<div class="container">

<label for="switch" class="sideButton left">
<div class="arrow">◀</div>
</label>

<label for="switch" class="sideButton right">
<div class="arrow">▶</div>
</label>

<div class="card">

<div class="side">
<h2>INICIAR SESIÓN</h2>
Correo
<input id="correoLogin" type="text">
Contraseña
<input id="passLogin" type="password">
<button onclick="login()">Entrar</button>
</div>

<div class="side register">
<h2>REGISTRO</h2>
Correo
<input id="correoReg" type="text">
Contraseña
<input id="passReg" type="password">
<button onclick="registro()">Crear Cuenta</button>
</div>

</div>
</div>

<div class="notify notifyLogin" id="avisosLogin"></div>
<div class="notify notifyRegister" id="avisosReg"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, child, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDSExbNQt2glE3uPIYIESbpR-WMyG2ts0M",
  authDomain: "act23-547b9.firebaseapp.com",
  databaseURL: "https://act23-547b9-default-rtdb.firebaseio.com",
  projectId: "act23-547b9",
  storageBucket: "act23-547b9.firebasestorage.app",
  messagingSenderId: "329465558346",
  appId: "1:329465558346:web:0f7667ed31a03c0589fdb3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Mostrar mensajes de aviso
function mostrarAviso(elemento,texto){
    elemento.style.display="block";
    elemento.innerHTML=texto;
    setTimeout(()=>{ elemento.style.display="none"; },5000);
}

// Hash seguro de contraseñas
async function hashPassword(password){
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

// Generar token seguro
function generarToken(){
    return crypto.randomUUID();
}

// Registro con ID incremental
window.registro = async function(){
    let correo = document.getElementById("correoReg").value.trim();
    let pass = document.getElementById("passReg").value;
    let avisos = document.getElementById("avisosReg");
    let texto="";

    // Validación
    if(!correo.includes("@") || correo.length>50) texto+="<div>Correo inválido</div>";
    if(!correo.includes("gmail.com")) texto+="<div>Debe ser gmail.com</div>";
    if(pass.length<8 || pass.length>100) texto+="<div>Contraseña inválida</div>";
    if(texto!=""){ mostrarAviso(avisos,texto); return; }

    // Obtener nuevo ID incremental
    const usuariosRef = ref(db, "usuarios");
    const snapshot = await get(usuariosRef);
    let newId = 1;
    if(snapshot.exists()){
        const datos = snapshot.val();
        const ids = Object.values(datos).map(u => parseInt(u.uid)).filter(n => !isNaN(n));
        if(ids.length>0) newId = Math.max(...ids) + 1;
    }

    const passHash = await hashPassword(pass);

    set(ref(db,"usuarios/user_" + newId),{
        uid: newId,
        correo: correo,
        password: passHash,
        privado: false
    });

    mostrarAviso(avisos,"✔ Cuenta creada correctamente");
}

// Login seguro con búsqueda por correo
window.login = async function(){
    let correo = document.getElementById("correoLogin").value.trim();
    let pass = document.getElementById("passLogin").value;
    let avisos = document.getElementById("avisosLogin");
    let texto="";

    if(!correo.includes("@") || correo.length>50) texto+="<div>Correo inválido</div>";
    if(!correo.includes("gmail.com")) texto+="<div>Debe ser gmail.com</div>";
    if(pass.length<8 || pass.length>100) texto+="<div>Contraseña inválida</div>";
    if(texto!=""){ mostrarAviso(avisos,texto); return; }

    const passHash = await hashPassword(pass);

    // Buscar usuario por correo
    const usuariosRef = ref(db,"usuarios");
    const usuariosSnapshot = await get(usuariosRef);
    if(usuariosSnapshot.exists()){
        const datos = usuariosSnapshot.val();
        let usuarioEncontrado = null;
        for(let key in datos){
            if(datos[key].correo === correo){
                usuarioEncontrado = datos[key];
                break;
            }
        }
        if(usuarioEncontrado && usuarioEncontrado.password === passHash){
            mostrarAviso(avisos,"✔ Inicio correcto");

            const token = generarToken();
            const expiracion = Date.now() + 30*60*1000; // 30 min
            localStorage.setItem("authToken", token);
            localStorage.setItem("userId", usuarioEncontrado.uid);
            localStorage.setItem("tokenExpiracion", expiracion);

            setTimeout(()=>{ window.location.href="loggin.html"; },1000);
        } else {
            mostrarAviso(avisos,"Correo o contraseña incorrecta");
        }
    } else {
        mostrarAviso(avisos,"Correo o contraseña incorrecta");
    }
}

// Verificar acceso a rutas protegidas
export function verificarAcceso(){
    const token = localStorage.getItem("authToken");
    const userId = localStorage.getItem("userId");
    const expiracion = localStorage.getItem("tokenExpiracion");

    if(!token || !userId || !expiracion || Date.now() > parseInt(expiracion)){
        localStorage.removeItem("authToken");
        localStorage.removeItem("userId");
        localStorage.removeItem("tokenExpiracion");
        window.location.href = "index.html";
    }
}

</script>

</body>
</html>
